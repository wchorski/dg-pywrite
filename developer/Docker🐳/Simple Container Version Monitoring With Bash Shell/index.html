<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Simple Container Version Monitoring With Bash Shell</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://fastly.jsdelivr.net/npm/mermaid@9.4.0/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({
        startOnLoad: true,
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-sv0slik/5O0JIPdLBCR2A3XDg/1U3WuDEheZfI/DI5n8Yqc3h5kjrnr46FGBNiUAJF7rE4LHKwQ/SoSLRKAxEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdn.jsdelivr.net/npm/lucide@0.115.0/dist/umd/lucide.min.js"></script>
<script>
    // Create callout icons
    window.addEventListener("load", () => {
        document.querySelectorAll(".callout").forEach((elem) => {
            const icon = getComputedStyle(elem).getPropertyValue('--callout-icon');
            const iconName = icon && icon.trim().replace(/^lucide-/, "");

            if (iconName) {
                const calloutTitle = elem.querySelector(".callout-title");

                if (calloutTitle) {
                    const calloutIconContainer = document.createElement("div");
                    const calloutIcon = document.createElement("i");

                    calloutIconContainer.appendChild(calloutIcon);
                    calloutIcon.setAttribute("icon-name", iconName);
                    calloutIconContainer.setAttribute("class", "callout-icon");
                    calloutTitle.insertBefore(calloutIconContainer, calloutTitle.firstChild);
                }
            }
        });

        lucide.createIcons();

        // Collapse callouts
        Array.from(document.querySelectorAll(".callout.is-collapsible")).forEach((elem) => {
            elem.querySelector('.callout-title').addEventListener("click", (event) => {
                if (elem.classList.contains("is-collapsed")) {
                    elem.classList.remove("is-collapsed");
                } else {
                    elem.classList.add("is-collapsed");
                }
            });
        });
    });
</script>


<script src="https://fastly.jsdelivr.net/npm/force-graph@1.43.0/dist/force-graph.min.js"></script>

<script defer src="https://fastly.jsdelivr.net/npm/@alpinejs/persist@3.11.1/dist/cdn.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/alpinejs@3.11.1/dist/cdn.min.js" defer></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer">
<script src="https://fastly.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<link href="/styles/digital-garden-base.css" rel="stylesheet">
    <link href="/styles/obsidian-base.css" rel="stylesheet">
    <link href="/styles/_theme.8f1d066a.css" rel="stylesheet">


<link href="/styles/custom-style.css" rel="stylesheet"><link href="/styles/user/pywrite.css" rel="stylesheet">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.webmanifest">





<style></style>
    
      <script async src="https://soup.tawtaw.site/ramen" data-website-id="fa4f8c5b-4767-4821-b063-f62c4cb90223"></script>
    
    
  </head>
  <body class="theme-dark markdown-preview-view markdown-rendered markdown-preview-section ">
    
    
    
      
    <nav class="navbar">
        <div class="navbar-inner">
            <a href="/" style="text-decoration: none;">
                <h1 style="margin: 15px !important;">Pywrite Garden</h1>
            </a>
        </div>
        
    </nav>
    
    

    

    <main class="content cm-s-obsidian ">
      <header>
        
        <div class="header-meta">
          </div>
      
      
      </header>
      
      
      <h2 id="pre-reqs" tabindex="-1">PreReqs</h2>
<div class="callout " data-callout="tip"><div class="callout-title"><div class="callout-title-inner"> Using jq Library<br></div></div>
<div class="callout-content">
<p>
I tried this with a mix of <code>grep awk sed</code> but wasn't worth the trouble. I ended up using the widely available <code>jq</code> library to parse the <strong>JSON</strong></p>
</div></div>
<p>This code assumes you pull everything from <a href="https://hub.docker.com/" target="_blank" class="external-link">Docker Hub Container Image Library | App Containerization</a>. I plan to support other container repos such as <code>ghcr.io</code> when I better understand how to variable this code.</p>
<p>I like when articles put the whole code first, so I'm doing that here. Below that I'll breakdown the thought process.</p>
<div class="callout " data-callout="tip"><div class="callout-title"><div class="callout-title-inner"> Packages without NAMESPACE<br></div></div>
<div class="callout-content">
<p>
Packages like <code>mariadb</code> don't come with a namespace. In this case use <code>library</code>. Example <code>https://hub.docker.com/v2/namespaces/library/repositories/mariadb/tags?page_size=60</code></p>
</div></div>
<h2 id="the-script" tabindex="-1">The Script</h2>
<pre><code class="language-bash">#!/bin/bash
REMOVABLE_WORDS=(&quot;latest&quot; &quot;lts&quot; &quot;beta&quot; &quot;stable&quot; &quot;develop&quot; &quot;active&quot; &quot;ubuntu&quot; &quot;apache&quot;)
cd /home/icicle/docker/
##! each item must have PREFIX, NAMESPACE, and REPO (even if it's an emty string) 
##! does not take into account anything but 'latest'. there was an error when `docker image inspect...` a `develop` image
##? may use later for `lscr.io/` or `ghcr.io/` packages
PREFIX=(      &quot;&quot;              &quot;&quot;            &quot;&quot;          &quot;&quot;                    &quot;&quot;           &quot;&quot;           &quot;&quot;            &quot;&quot;                        &quot;&quot;)
NAMESPACES=(  &quot;portainer&quot;     &quot;linuxserver&quot; &quot;library&quot;   &quot;jc21&quot;                &quot;photoprism&quot; &quot;prom&quot;       &quot;vaultwarden&quot; &quot;library&quot;                 &quot;library&quot;)
REPOSITORIES=(&quot;portainer-ce&quot;  &quot;duplicati&quot;   &quot;nextcloud&quot; &quot;nginx-proxy-manager&quot; &quot;photoprism&quot; &quot;prometheus&quot; &quot;server&quot;      &quot;wordpress&quot;               &quot;mariadb&quot;)
##? if empty string assumed &quot;:latest&quot;
LOCAL_TAGS=(  &quot;&quot;              &quot;&quot;            &quot;:29&quot;       &quot;&quot;                    &quot;&quot;           &quot;&quot;           &quot;&quot;            &quot;:php8.2&quot;                 &quot;&quot;)

### todo
## set all the arrays above as one JSON object that is parsed with `jq`

handle_string_clean() {
  if [[ -z &quot;$1&quot; ]]
    then
      echo &quot;not_found&quot;
      ## break out of function if nothing was found in `curl`
      return 1
    fi

  IFS=' ' readarray -t original_array &lt;&lt;&lt; &quot;$1&quot;

  # Declare an associative array (dictionary) for words to remove
  declare -A remove_dict
  for word in &quot;${REMOVABLE_WORDS[@]}&quot;
  do
    remove_dict[&quot;$word&quot;]=1
  done

  filtered_array=()
  for word in &quot;${original_array[@]}&quot;
  do
    if [[ -z &quot;${remove_dict[&quot;$word&quot;]}&quot; ]]
    then
      filtered_array+=(&quot;$word&quot;)
    fi
  done

  local longest_string=&quot;&quot;
  ## Iterate over each string in the array and return string with most information (this isn't perfect but works for me)
  for str in &quot;${filtered_array[@]}&quot;
  do
    [ ${#str} -gt ${#longest_string} ] &amp;&amp; longest_string=$str
  done

  echo &quot;$longest_string&quot;
}
## start with empty file, or delete previous data
# : &gt; &quot;./.logs/all-images.log&quot;
date &gt; &quot;./.logs/all-images.log&quot;
echo &quot;##########&quot; &gt; &quot;./.logs/all-images.log&quot;

for i in &quot;${!REPOSITORIES[@]}&quot;
do
  REPO=&quot;${REPOSITORIES[$i]}&quot;
  if [ -z &quot;${LOCAL_TAGS[i]}&quot; ] || [ &quot;${LOCAL_TAGS[i]}&quot; = &quot;:latest&quot; ]
  then
    # Perform action if LOCAL_TAG is empty &quot;&quot; or equals &quot;:latest&quot;
    localDigest=$(docker image inspect --format '{{index .RepoDigests 0}}' &quot;${PREFIX[i]}${NAMESPACES[i]}/$REPO${LOCAL_TAGS[i]}&quot; | awk -F'@' '{print $2}')
    ##? I set `page_size` to 100 as sometimes the image you're looking for either gets burried under new releases or is very old. the max is 100
    localVersions=$(      curl -s &quot;https://hub.docker.com/v2/namespaces/${NAMESPACES[i]}/repositories/$REPO/tags?page_size=100&quot; -H 'Content-Type: application/json' | jq -r '.results[] | select(.digest == &quot;'$localDigest'&quot;) | .name')
  else
    localVersions=${LOCAL_TAGS[i]}
  fi

  repoLatestDigest=$(   curl -s &quot;https://hub.docker.com/v2/namespaces/${NAMESPACES[i]}/repositories/$REPO/tags/latest&quot; -H 'Content-Type: application/json' | jq -r '.digest')
  repoLatestVersions=$( curl -s &quot;https://hub.docker.com/v2/namespaces/${NAMESPACES[i]}/repositories/$REPO/tags?page_size=100&quot; -H 'Content-Type: application/json' | jq -r '.results[] | select(.digest == &quot;'$repoLatestDigest'&quot;) | .name')

  cleanlocalVersion=$(handle_string_clean &quot;$localVersions&quot;)
  cleanRepoLatestVersion=$(handle_string_clean &quot;$repoLatestVersions&quot;)
  
  CLEAN_FILENAME=$(sed -E 's/(http|https):\/\///g' &lt;&lt;&lt; &quot;${NAMESPACES[i]}_$REPO&quot; | sed 's/\//_/g')

  ## for one log file
  echo $CLEAN_FILENAME &gt;&gt; &quot;./.logs/all-images.log&quot;
  echo $cleanlocalVersion &gt;&gt; &quot;./.logs/all-images.log&quot;
  echo $cleanRepoLatestVersion &gt;&gt; &quot;./.logs/all-images.log&quot;
  echo &quot;---&quot; &gt;&gt; &quot;./.logs/all-images.log&quot;
  ## for single file logs | `-n` stops 2nd line from being created
  echo -n $cleanlocalVersion &gt; &quot;./.logs/local-version/$CLEAN_FILENAME.log&quot;    
  echo -n $cleanRepoLatestVersion &gt; &quot;./.logs/repo-version/$CLEAN_FILENAME.log&quot;
  ## for local terminal output
  echo $CLEAN_FILENAME
  echo &quot;local : $cleanlocalVersion&quot;
  echo &quot;latest: $cleanRepoLatestVersion&quot;
  echo &quot;---&quot;
done
</code></pre>
<h2 id="explanation" tabindex="-1">Explanation</h2>
<p>The code above goes over these steps</p>
<ol>
<li>define array of tags that I don't care about. We'll use this later (we want the actual version number i.e. <code>v2.3.1</code>)</li>
<li>define a few arrays that correspond to
<ol>
<li><code>PREFIX</code>: where the registry is (will support later)</li>
<li><code>NAMESPACES</code>: The developer (namespace)</li>
<li><code>REPOSITORIES</code>: the package (image, container, app)</li>
</ol>
</li>
<li>define a function to be used later. This will clean up the string from unwanted words, or return <code>not_found</code></li>
<li>Now we get into local docker and scraping an API
<ol>
<li><code>localDigest</code> gets the current digest of your local images</li>
<li><code>localVersions</code> calls the remote API to tell us what version tags correspond to that digest ID</li>
<li><code>repoLatestDigest</code> grabs whatever image tagged as <code>latest</code> and returns it's digest ID</li>
<li><code>repoLatestVersions</code> same as local, we return all tags associated to the registries digest ID</li>
<li>We clean up the strings with unwanted tags</li>
<li>print the output to separate <code>./.logs/local-version/$CLEAN_FILENAME.log</code> and <code>./.logs/repo-version/$CLEAN_FILENAME.log</code> respectively.</li>
<li>From there I'm gonna use <strong>Home Assistant</strong> to view and compare these version numbers</li>
</ol>
</li>
</ol>
<p>Because of the obtuse nature of tag naming, there is no good way a computer can compare and notify how out of date a package can be, but this should be a good alternative for people who want to monitor their container without an auto updater like <a href="https://containrrr.dev/watchtower/" target="_blank" class="external-link">Watchtower</a></p>
<p>I'll put this script to run in a <code>cron job</code> and my <strong>Home Assistant</strong> dashboard does the rest.</p>
<h2 id="output" tabindex="-1">Output</h2>
<p>With echo logs in place, this is what your console will look like. I'm thinking either I keep the <code>repo</code> and <code>local</code> files separate, or just print 1 file like this per image.</p>
<pre><code class="language-shell">Thu 18 Jul 2024 02:53:57 PM CDT
##########
portainer_portainer-ce
2.19.5
2.19.5
---
linuxserver_duplicati
v2.0.8.1-2.0.8.1_beta_2024-05-07-ls211
version-v2.0.8.1-2.0.8.1_beta_2024-05-07
---
library_nextcloud
:29
29.0.3-apache
---
jc21_nginx-proxy-manager
2.11.3
2.11.3
---
...
</code></pre>
<h2 id="postmortem" tabindex="-1">Postmortem</h2>
<p>Is there a better way to do this? Maybe. I could have simplified things by just comparing <code>update_date</code> value, but that would only tell me how old the version was, not if it was a minor or major change. There is this promising <a href="https://github.com/docker/hub-tool" target="_blank" class="external-link">cli hub-tool</a>, but still too new to tell.</p>
<p>This is a great example of making a lack luster API work for you. We have to visit the API twice per package, and we have to filter through 60 results just to get the 1 we want (<code>page_size=60</code>) since the version we want could live lower down the list. It's expensive, but it works.</p>
<h2 id="troubleshooting" tabindex="-1">Troubleshooting</h2>
<p>Here is a brain dump of how I got to the above code. It's kinda a mess, but it's how I understood the who, what's, and where's</p>
<p><a class="internal-link" target="" data-note-icon="" href="/developer/Home Lab/Plex.tv/">Plex.tv</a> spun up with docker using the image <code>plexinc/pms-docker:latest</code>.</p>
<pre><code class="language-bash">docker inspect -f '{{ index .Config.Labels }}' plex-pms
</code></pre>
<p>result</p>
<pre><code class="language-shell">map[com.docker.compose.config-hash:e96e81440276b8a02fec58af98c56d30d07e627cd39a8b2777aff81cf8cb2b83 com.docker.compose.container-number:1 com.docker.compose.depends_on: com.docker.compose.image:sha256:71b670b00350313ebea61b03472558a947f4858701e811ccb35f174c47897182 com.docker.compose.oneoff:False com.docker.compose.project:plex com.docker.compose.project.config_files:/home/spearmint/docker/plex/compose.yml com.docker.compose.project.working_dir:/home/spearmint/docker/plex com.docker.compose.replace:d78e27f7ea6638aa2d39d1a68b16c3fd985e9c129a2f43b3c8a072e9e26cf1fc com.docker.compose.service:plex com.docker.compose.version:2.28.1 org.opencontainers.image.created:2024-06-06T18:28:43.381Z org.opencontainers.image.description:&quot;The Plex Media Server&quot; org.opencontainers.image.licenses:NOASSERTION org.opencontainers.image.ref.name:ubuntu org.opencontainers.image.revision:4d68c05a62e861a4b9b87b48f6df102b62d68666 org.opencontainers.image.source:https://github.com/plexinc/pms-docker org.opencontainers.image.title:Plex Media Server org.opencontainers.image.url:https://github.com/plexinc/plex-media-server org.opencontainers.image.vendor:Plex, GmbH org.opencontainers.image.version:1.40.3.8555-fef15d30c]
</code></pre>
<p>There was a lot of discrepancy on what data was returned on inspect. So returning the whole json and dropping in a text editor to make it format helped me understand</p>
<pre><code class="language-bash">docker inspect -f json plex-pms
</code></pre>
<p>the label I'm interested in is <code>org.opencontainers.image.version</code> with value <code>1.40.3.8555-fef15d30c</code></p>
<pre><code class="language-bash">docker inspect -f '{{ index .Config.Labels &quot;org.opencontainers.image.version&quot;}}' plex-pms
</code></pre>
<p>local image and container date created</p>
<pre><code class="language-bash">docker image inspect --format '{{.Created }}' jellyfin/jellyfin
docker container inspect --format '{{.Created }}' jellyfin
docker inspect -f '{{ index .Config.Env 9 }}' duplicati
</code></pre>
<p>registery image date updated <code>last_updated</code>. You can open the url in a browser to see the whole json file</p>
<pre><code class="language-bash">curl https://registry.hub.docker.com/v2/repositories/jellyfin/jellyfin/tags/latest | grep -o '&quot;last_updated&quot;: *&quot;[^&quot;]*&quot;' | sed 's/&quot;last_updated&quot;: *&quot;//' | sed 's/&quot;//'
</code></pre>
<p>get latest version number from github</p>
<pre><code class="language-bash">curl -s &quot;https://api.github.com/repos/jellyfin/jellyfin/releases/latest&quot; | grep -Po '&quot;tag_name&quot;: &quot;\K.*?(?=&quot;)'
</code></pre>
<h3 id="get-latest-version-number-from-docker-hub" tabindex="-1">Get latest version number from docker hub</h3>
<p>Here is an example of how I'd grab the latest version number of the <a class="internal-link" target="" data-note-icon="" href="/developer/Home Lab/Duplicati/">Duplicati</a> docker hub repo image. Later I'll show how to process an array of different image repos.</p>
<pre><code class="language-bash">## search dockerhub for images taged with 'latest' and get unique digest number
repoLatestDigest=$(curl -s 'https://hub.docker.com/v2/repositories/duplicati/duplicati/tags' -H 'Content-Type: application/json' | jq -r '.results[] | select(.name == &quot;'latest'&quot;) | .digest')

## search dockerhub again with digest number. Filter out any images that don't match
repoLatestVersions=$(curl -s 'https://hub.docker.com/v2/repositories/duplicati/duplicati/tags' -H 'Content-Type: application/json' | jq -r '.results[] | select(.digest == &quot;'$repoLatestDigest'&quot;) | .name')

## remove any images named by keyword to only return actual numerical version number
removable_words=(&quot;latest&quot; &quot;beta&quot; &quot;stable&quot;)
for word in &quot;${removable_words[@]}&quot;
do
  repoLatestVersions=$(echo &quot;$repoLatestVersions&quot; | sed -E &quot;s/\b${word}\b//g&quot;)
done
# Remove any extra spaces that may be left
repoLatestVersions=$(echo &quot;$repoLatestVersions&quot; | sed -E 's/ +/ /g' | sed -E 's/^ +| +$//g')

echo $repoLatestVersions &gt; ./.logs/repo-version/duplicati.log
</code></pre>
<hr>
<h2 id="credits" tabindex="-1">Credits</h2>
<ul>
<li><a href="https://docs.linuxserver.io/images/docker-plex/#support-info" target="_blank" class="external-link">LinuxServer.io | Docker Inspect</a></li>
<li><a href="https://stackoverflow.com/questions/58209785/finding-the-actual-version-of-latest-version-of-docker-image" target="_blank" class="external-link">dockerhub - Finding the actual version of latest version of docker image - Stack Overflow</a></li>
<li><a href="https://stackoverflow.com/questions/10586153/how-to-split-a-string-into-an-array-in-bash" target="_blank" class="external-link">How to split a string into an array in Bash? - Stack Overflow</a></li>
<li><a href="https://stackoverflow.com/questions/3685970/check-if-a-bash-array-contains-a-value" target="_blank" class="external-link">Check if a Bash array contains a value - Stack Overflow</a></li>
<li><a href="https://github.com/orgs/community/discussions/26279" target="_blank" class="external-link">How to check if a container image exists on GHCR? · community · Discussion <a class="tag" onclick="toggleTagSearch(this)" data-content="#26279">#26279</a> (github.com)</a></li>
<li><a href="https://stackoverflow.com/questions/56193110/how-can-i-use-docker-registry-http-api-v2-to-obtain-a-list-of-all-repositories-i" target="_blank" class="external-link">How can I use Docker Registry HTTP API V2 to obtain a list of all repositories in Docker Hub? - Stack Overflow</a></li>
</ul>

      
      
    </main>

    

    
        <script>
      if (window.location.hash) {
        document.getElementById(window.location.hash.slice(1)).classList.add('referred');
      }
      window.addEventListener('hashchange', (evt) => {
        const oldParts = evt.oldURL.split("#");
        if (oldParts[1]) {
          document.getElementById(oldParts[1]).classList.remove('referred');
        }
        const newParts = evt.newURL.split("#");
        if (newParts[1]) {
          document.getElementById(newParts[1]).classList.add('referred');
        }
      }, false);
      const url_parts = window.location.href.split("#")
      const url = url_parts[0];
      const referrence = url_parts[1];
      document.querySelectorAll(".cm-s-obsidian > *[id]").forEach(function (el) {
        el.ondblclick = function(evt) {
          const ref_url = url + '#' + evt.target.id
          navigator.clipboard.writeText(ref_url);
      }
      });

      
    </script>
    <script src=" https://fastly.jsdelivr.net/npm/luxon@3.2.1/build/global/luxon.min.js "></script>
<script defer>
    TIMESTAMP_FORMAT = "MMM dd, yyyy h:mm a";
    document.querySelectorAll('.human-date').forEach(function (el) {
        el.innerHTML = luxon.DateTime.fromISO(el.getAttribute('data-date') || el.innerText).toFormat(TIMESTAMP_FORMAT);
      });
</script>
    
    
    <script>
lucide.createIcons({
            attrs: {
                class: ["svg-icon"]
            }
        });
</script>
  </body>
</html>
